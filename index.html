<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BlueForge — Visual AI Web Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ace Editor (syntax highlighting) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js" integrity="sha512-0FcdxK1MSbKDb1uVYy3x2jcpuRmX90P8zFS8hvP+skg2v0QfXkIVWSx7Hml4l3a2eTz/sCAX5Q0nQxSjtyHReg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- JSZip + FileSaver (export project) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-VnL9fKxXO5q3b7dH1cUAh2uIy0hRWHkMgO7h58KkC6aXe7H3O/Y4gqN0DmpqG7qmqbil26QWmL0CjP6R2hF6Wg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-5x6Hq+1TnM1z0M9q0d6bUo8uzf9zvNwQY6n2VwVf+enPqjRz0l04iB7kq4tXjJfK7B8VtHj7DqG4TtYBZhA5mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root {
      --bg: #0b1220;
      --bg-elev: #0f172a;
      --panel: #0b1220;
      --muted: #9fb3ff;
      --text: #e6eeff;
      --text-dim: rgba(230, 238, 255, 0.7);
      --blue-50: #eff6ff;
      --blue-100: #dbeafe;
      --blue-200: #bfdbfe;
      --blue-400: #60a5fa;
      --blue-500: #3b82f6;
      --blue-600: #2563eb;
      --blue-700: #1d4ed8;
      --blue-800: #1e40af;
      --accent: var(--blue-600);
      --accent-2: var(--blue-700);
      --ring: rgba(59,130,246,.4);
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --gap: 14px;
      --shadow: 0 12px 40px rgba(0,0,0,0.35), inset 0 1px rgba(255,255,255,0.06);
      --border: 1px solid rgba(120,144,255,0.16);
      --panel-border: 1px solid rgba(120,144,255,0.12);
      --glass: linear-gradient(180deg, rgba(29,78,216,0.12), rgba(2,6,23,0.6));
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(33, 99, 255, 0.18), transparent 60%), radial-gradient(1000px 600px at 120% 10%, rgba(99, 102, 241, 0.12), transparent 60%), #0a0f1f;
      color: var(--text);
      font: 14px/1.45 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Inter, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header.appbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(120%) blur(12px);
      background: radial-gradient(1200px 400px at 40% -50%, rgba(37,99,235,.15), transparent 60%), linear-gradient(180deg, rgba(8,47,73,0.28), rgba(2,6,23,0.4));
      border-bottom: var(--panel-border);
    }
    .appbar-inner {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: var(--gap);
      padding: 12px 18px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .brand {
      display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: .2px;
    }
    .brand .logo {
      width: 34px; height: 34px; border-radius: 10px;
      background: conic-gradient(from 210deg, var(--blue-600), var(--blue-400), var(--blue-700));
      box-shadow: 0 8px 28px rgba(37,99,235,0.4);
    }
    .brand span { color: #eaf1ff; font-size: 16px }
    .brand small { color: var(--muted); font-weight: 600; font-size: 11px; letter-spacing: .6px }

    .actions, .right-actions { display: flex; gap: 8px; align-items: center; justify-content: center }
    .right-actions { justify-content: flex-end }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px;
      border: var(--panel-border); color: var(--text); background: rgba(2,6,23,0.35);
      box-shadow: inset 0 1px rgba(255,255,255,0.06);
      cursor: pointer; text-decoration: none; user-select: none;
    }
    .btn:hover { background: rgba(2,6,23,0.5) }
    .btn.primary { background: linear-gradient(180deg, var(--accent), var(--accent-2)); border: 1px solid rgba(59,130,246,0.6); box-shadow: 0 10px 25px rgba(37,99,235,.35); }
    .btn.primary:hover { filter: brightness(1.05) }
    .btn.ghost { background: transparent }
    .btn.small { padding: 6px 10px; border-radius: 9px; font-size: 12px }
    .sep { width: 1px; height: 26px; background: rgba(120,144,255,0.18) }

    main.layout {
      max-width: 1600px; margin: 16px auto; padding: 0 18px 18px;
      display: grid; gap: var(--gap);
      grid-template-columns: 360px minmax(440px, 1fr) minmax(420px, 520px);
    }
    .panel {
      border: var(--panel-border);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex; flex-direction: column;
      min-height: 200px;
    }
    .panel-header {
      padding: 12px 14px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      background: linear-gradient(180deg, rgba(148,163,255,0.06), rgba(0,0,0,0));
      border-bottom: var(--panel-border);
    }
    .panel-header h3 { margin: 0; font-size: 13px; letter-spacing: .4px; text-transform: uppercase; color: var(--muted) }
    .panel-body { padding: 12px; flex: 1; overflow: auto }

    /* Interaction (chat + components) */
    .chat {
      display: grid; grid-template-rows: 1fr auto; gap: 10px; height: 100%;
    }
    .messages { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: auto; padding-right: 4px }
    .msg {
      display: grid; grid-template-columns: 28px 1fr; gap: 10px;
      align-items: start;
    }
    .msg .avatar {
      width: 28px; height: 28px; border-radius: 7px; background: linear-gradient(180deg, var(--blue-600), var(--blue-800));
      display: grid; place-items: center; color: #fff; font-weight: 700; font-size: 12px;
      box-shadow: 0 6px 18px rgba(37,99,235,0.35);
    }
    .msg.user .avatar { background: linear-gradient(180deg, #0ea5e9, #0284c7) }
    .bubble {
      background: rgba(15,23,42,0.6); border: var(--panel-border); border-radius: 12px; padding: 10px 12px; color: var(--text);
    }
    .bubble small { color: var(--text-dim) }

    .composer {
      display: grid; grid-template-columns: 1fr auto; gap: 8px; padding-top: 4px; border-top: var(--panel-border);
    }
    .input {
      background: rgba(2,6,23,0.45); border: var(--panel-border); border-radius: 12px; padding: 10px 12px; color: var(--text);
      outline: none; width: 100%; resize: none; min-height: 46px; max-height: 140px; overflow: auto;
    }

    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0 0 }
    .chip { border: var(--panel-border); background: rgba(2,6,23,0.35); padding: 5px 8px; border-radius: 10px; font-size: 12px; color: var(--muted); cursor: pointer }
    .chip:hover { background: rgba(2,6,23,0.5) }

    .comp-list { display: flex; flex-direction: column; gap: 8px }
    .comp-item {
      border: var(--panel-border); border-radius: 10px; padding: 8px 10px;
      background: rgba(2,6,23,0.35); display: grid; gap: 8px;
    }
    .comp-item .row { display: flex; align-items: center; justify-content: space-between; gap: 8px }
    .tag { font-size: 11px; color: var(--muted); background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); padding: 2px 6px; border-radius: 999px }

    /* Editor Pane */
    .tabs { display: flex; gap: 8px; align-items: center }
    .tab {
      padding: 6px 10px; border-radius: 10px; border: var(--panel-border); background: rgba(2,6,23,0.35);
      color: var(--muted); cursor: pointer; font-size: 12px;
    }
    .tab.active { background: linear-gradient(180deg, rgba(59,130,246,0.22), rgba(2,6,23,0.55)); color: var(--text) }
    .editor {
      position: relative; border-top: var(--panel-border); flex: 1; min-height: 340px;
    }
    .editor .ace_editor { position: absolute; inset: 0; font-size: 13px; }

    .toolrow { display: flex; align-items: center; gap: 8px; flex-wrap: wrap }

    /* Preview Pane */
    .preview-controls { display: flex; gap: 8px; align-items: center }
    .device { padding: 6px 10px; border-radius: 10px; border: var(--panel-border); background: rgba(2,6,23,0.35); color: var(--muted); cursor: pointer; font-size: 12px }
    .device.active { background: linear-gradient(180deg, rgba(59,130,246,0.22), rgba(2,6,23,0.55)); color: var(--text) }

    .iframe-wrap {
      border-top: var(--panel-border);
      background: #0a0f1f;
      flex: 1; display: grid; place-items: center; padding: 10px;
    }
    .iframe-shell {
      width: 100%; height: 100%; border-radius: 12px; overflow: hidden;
      border: 1px solid rgba(120,144,255,0.2); box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: grid; place-items: center;
    }
    iframe.preview {
      width: 100%; height: 100%; border: 0; background: white;
    }

    /* Utility */
    .hidden { display: none !important }
    .mt8 { margin-top: 8px }
    .ml-auto { margin-left: auto }
    .green { color: var(--ok) }
    .yellow { color: var(--warn) }
    .red { color: var(--danger) }
    .field {
      display: grid; gap: 6px; margin: 8px 0;
    }
    .field label { font-size: 12px; color: var(--muted) }
    .field input[type="color"] { background: transparent; border: none; width: 36px; height: 28px; padding: 0; cursor: pointer }
    @media (max-width: 1200px) {
      main.layout {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "chat editor"
          "preview preview";
      }
      .panel.interaction { grid-area: chat }
      .panel.editors { grid-area: editor }
      .panel.preview { grid-area: preview; min-height: 360px }
    }
    @media (max-width: 920px) {
      main.layout { grid-template-columns: 1fr; grid-template-areas: "chat" "editor" "preview"; }
    }
  </style>
  </head>
  <body>
  <!-- Top App Bar -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>BlueForge</span> <small>Visual AI Builder</small>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnNew">New</button>
        <button class="btn ghost" id="btnImport">Import</button>
        <div class="sep"></div>
        <button class="btn" id="btnDownload">Export ZIP</button>
        <button class="btn primary" id="btnBuild">Build Preview</button>
      </div>
      <div class="right-actions">
        <div class="field" style="align-items:center; grid-auto-flow: column; gap:10px; margin:0">
          <label for="accentColor">Accent</label>
          <input type="color" id="accentColor" value="#2563eb" title="Primary Accent Color" />
        </div>
        <button class="btn small" id="btnDark">Toggle Dark Preview</button>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- Interaction Panel -->
    <section class="panel interaction">
      <div class="panel-header">
        <h3>Interaction</h3>
        <div class="toolrow">
          <span class="tag">NL ➜ Code</span>
          <button class="btn small" id="btnHelp">Help</button>
        </div>
      </div>
      <div class="panel-body chat">
        <div class="messages" id="messages">
          <!-- Seeded AI helper tip -->
          <div class="msg ai">
            <div class="avatar">A</div>
            <div class="bubble">
              <strong>Welcome!</strong> Tell me what to build. Examples:
              <ul>
                <li>Build a landing page with a navbar, hero, and pricing.</li>
                <li>Add a contact form with name, email, message.</li>
                <li>Make the navbar sticky and set the logo to “BlueForge”.</li>
                <li>Change the primary color to #1e40af.</li>
              </ul>
              I’ll generate clean, well-commented HTML, CSS, and JS—and you’ll see the live preview update.
            </div>
          </div>
        </div>
        <div class="composer">
          <textarea id="input" class="input" placeholder="Describe what you want to build... (e.g., 'Add a responsive navbar with a logo BlueForge and links Home, Features, Pricing, Contact')"></textarea>
          <button class="btn primary" id="btnSend">Generate</button>
        </div>

        <div class="mt8">
          <div class="chips">
            <div class="chip" data-quick="Add a responsive navbar with logo BlueForge and links Home, Features, Pricing, Contact">+ Navbar</div>
            <div class="chip" data-quick="Add a centered hero with title Elevate your web dev, subtitle Build faster with AI, primary button Get started, secondary button Learn more">+ Hero</div>
            <div class="chip" data-quick="Add a pricing section with three plans: Starter, Pro, Enterprise">+ Pricing</div>
            <div class="chip" data-quick="Add a contact form with name, email, message and a submit button Send message">+ Contact Form</div>
            <div class="chip" data-quick="Add a simple footer with links About, Privacy, Terms">+ Footer</div>
          </div>
          <h4 style="margin:12px 0 6px; color: var(--muted); font-size:12px; letter-spacing:.4px; text-transform:uppercase">Components</h4>
          <div id="compList" class="comp-list"></div>
        </div>
      </div>
    </section>
    <!-- Editor Panel -->
    <section class="panel editors">
      <div class="panel-header">
        <h3>Editor</h3>
        <div class="toolrow">
          <div class="tabs">
            <div class="tab active" data-tab="html">HTML</div>
            <div class="tab" data-tab="css">CSS</div>
            <div class="tab" data-tab="js">JS</div>
          </div>
          <button class="btn small" id="btnFormat">Format</button>
          <button class="btn small" id="btnInsertBase">Insert Base Template</button>
          <span class="ml-auto" style="color:var(--muted); font-size:12px">Edits update preview automatically</span>
        </div>
      </div>
      <div class="editor">
        <div id="htmlEditor" class="code"></div>
        <div id="cssEditor" class="code hidden"></div>
        <div id="jsEditor" class="code hidden"></div>
      </div>
    </section>
    <!-- Preview Panel -->
    <section class="panel preview">
      <div class="panel-header">
        <h3>Live Preview</h3>
        <div class="preview-controls">
          <button class="device" data-w="375">Mobile</button>
          <button class="device" data-w="768">Tablet</button>
          <button class="device active" data-w="100%">Desktop</button>
          <button class="btn small" id="btnReload">Reload</button>
        </div>
      </div>
      <div class="iframe-wrap">
        <div class="iframe-shell" id="iframeShell">
          <iframe class="preview" id="preview"></iframe>
        </div>
      </div>
    </section>
  </main>
    <script>
    // -------------------------------
    // BlueForge Visual AI Builder
    // -------------------------------
    // Architecture:
    // - HTML/CSS/JS editors (Ace)
    // - Live preview via iframe.srcdoc
    // - Interaction area parses plain-English instructions into components
    // - Components are inserted with identifiable markers for regeneration/editing
    // - Export as ZIP
    //
    // Note: This is fully client-side; the "AI" here is a rule-based generator that
    // covers common web components. You can wire it to any LLM via an API if desired.

    // Project state
    const Project = {
      theme: {
        accent: '#2563eb',
        darkPreview: false,
      },
      // Managed components tracked here for editing/regeneration
      components: [], // {id, type, options}
      // Utility to generate unique ids
      nextId: 1
    };

    // DOM refs
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const input = $('#input');
    const messages = $('#messages');
    const compList = $('#compList');
    const accentPicker = $('#accentColor');
    const iframe = $('#preview');
    const iframeShell = $('#iframeShell');

    // Editors (Ace)
    const htmlEditor = ace.edit('htmlEditor', { theme: 'ace/theme/tomorrow_night_eighties', mode: 'ace/mode/html', useWorker: false });
    const cssEditor  = ace.edit('cssEditor',  { theme: 'ace/theme/tomorrow_night_eighties', mode: 'ace/mode/css', useWorker: false });
    const jsEditor   = ace.edit('jsEditor',   { theme: 'ace/theme/tomorrow_night_eighties', mode: 'ace/mode/javascript', useWorker: false });

    htmlEditor.setOptions({ fontSize: '13px', tabSize: 2, useSoftTabs: true, wrap: true });
    cssEditor.setOptions({ fontSize: '13px', tabSize: 2, useSoftTabs: true, wrap: true });
    jsEditor.setOptions({ fontSize: '13px', tabSize: 2, useSoftTabs: true, wrap: true });

    // Base CSS — inserted in the preview to give clean defaults
    const baseCSS = () => `
      /* ---- Base Styles injected by BlueForge (safe to remove in your export) ---- */
      :root {
        --accent: ${Project.theme.accent};
        --accent-700: ${shade(Project.theme.accent, -12)};
        --bg: ${Project.theme.darkPreview ? '#0b1220' : '#ffffff'};
        --text: ${Project.theme.darkPreview ? '#e5edff' : '#0f172a'};
        --muted: ${Project.theme.darkPreview ? 'rgba(229,237,255,0.7)' : '#334155'};
        --card: ${Project.theme.darkPreview ? '#0f172a' : '#f8fafc'};
        --ring: ${Project.theme.darkPreview ? 'rgba(96,165,250,.35)' : 'rgba(59,130,246,.35)'};
      }
      * { box-sizing: border-box }
      body {
        margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
        background: var(--bg); color: var(--text); line-height: 1.6;
      }
      a { color: var(--accent); text-decoration: none }
      img { max-width: 100%; display: block }
      .container { width: min(1140px, 92%); margin: 0 auto }
      .btn {
        display: inline-flex; align-items: center; gap: .5rem; padding: .7rem 1rem; border-radius: 10px; font-weight: 600;
        background: var(--accent); color: white; border: 1px solid rgba(0,0,0,.05); box-shadow: 0 6px 14px rgba(37,99,235,.25); cursor: pointer;
      }
      .btn.secondary {
        background: transparent; color: var(--accent); border: 1px solid var(--accent);
      }
      .card {
        background: var(--card); border: 1px solid rgba(0,0,0,.06); border-radius: 14px; padding: 1rem;
        box-shadow: ${Project.theme.darkPreview ? '0 6px 18px rgba(0,0,0,.35)' : '0 6px 18px rgba(2,6,23,.05)'};
      }
      /* Simple reveal animation */
      .reveal { opacity: 0; transform: translateY(10px); transition: .5s ease }
      .reveal.revealed { opacity: 1; transform: none }
    `;

    // Default starter template in editors
    const starterHTML = `
<!-- App Shell (you can remove comments safely) -->
<header class="site-header">
  <div class="container">
    <nav class="nav">
      <a href="#" class="brand">BlueForge</a>
      <button class="nav-toggle" aria-label="Toggle menu">☰</button>
      <ul class="links">
        <li><a href="#">Home</a></li>
        <li><a href="#features">Features</a></li>
        <li><a href="#pricing">Pricing</a></li>
      </ul>
      <a class="btn" href="#get-started">Get started</a>
    </nav>
  </div>
</header>

<main>
  <section class="hero">
    <div class="container">
      <h1>Build beautiful sites faster</h1>
      <p class="sub">Design, edit, and preview in one place — powered by an AI assistant.</p>
      <div class="cta">
        <a class="btn" href="#get-started">Get started</a>
        <a class="btn secondary" href="#learn-more">Learn more</a>
      </div>
    </div>
  </section>

  <section id="features" class="features">
    <div class="container">
      <div class="grid">
        <div class="card reveal"><h3>Clean code</h3><p>Accessible, semantic, and easy to edit.</p></div>
        <div class="card reveal"><h3>Live preview</h3><p>Instant updates as you type.</p></div>
        <div class="card reveal"><h3>Components</h3><p>Navbar, hero, pricing, forms, and more.</p></div>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container">
    <p>© <span id="year"></span> BlueForge. All rights reserved.</p>
  </div>
</footer>
`.trim();

    const starterCSS = `
/* Site Header (responsive) */
.site-header { position: sticky; top: 0; backdrop-filter: blur(8px); background: ${Project.theme.darkPreview ? 'rgba(15,23,42,.5)' : 'rgba(255,255,255,.8)'}; border-bottom: 1px solid rgba(0,0,0,.06); z-index: 40 }
.nav { display: grid; grid-template-columns: auto 1fr auto auto; gap: 1rem; align-items: center; padding: .7rem 0 }
.brand { font-weight: 800; color: var(--text); font-size: 1.1rem }
.links { display: flex; gap: 1rem; list-style: none; padding: 0; margin: 0 }
.links a { color: var(--text); opacity: .8 }
.links a:hover { opacity: 1 }
.nav-toggle { display: none; }

@media (max-width: 800px) {
  .nav { grid-template-columns: auto auto 1fr; grid-template-areas: "brand toggle cta" "links links links" }
  .brand { grid-area: brand }
  .nav-toggle { grid-area: toggle; display: inline-flex; border: 1px solid rgba(0,0,0,.1); background: transparent; padding: .4rem .6rem; border-radius: 8px; color: var(--text) }
  .links { grid-area: links; display: none; flex-direction: column; gap: .6rem; margin: .6rem 0 }
  .links.open { display: flex }
}

/* Hero */
.hero { padding: clamp(2.4rem, 6vw, 4rem) 0 }
.hero h1 { font-size: clamp(1.8rem, 4.6vw, 3rem); line-height: 1.1; margin: 0 0 .6rem }
.hero .sub { color: var(--muted); max-width: 54ch }
.cta { display: flex; gap: .8rem; margin-top: 1rem }

/* Features grid */
.features { padding: 2rem 0; }
.features .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 1rem }

/* Footer */
.site-footer { padding: 2rem 0; border-top: 1px solid rgba(0,0,0,.06); color: var(--muted); font-size: .95rem; }

/* Helpers */
.section { padding: 2rem 0 }
`.trim();

    const starterJS = `
// Small enhancements and utilities
document.querySelector('#year')?.appendChild(document.createTextNode(String(new Date().getFullYear())));

// Reveal on scroll
const io = new IntersectionObserver(entries => {
  entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
}, { threshold: 0.14 });
document.querySelectorAll('.reveal').forEach(el => io.observe(el));

// Nav toggle (mobile)
document.querySelector('.nav-toggle')?.addEventListener('click', () => {
  document.querySelector('.links')?.classList.toggle('open');
});
`.trim();

    // Init editors with starter content
    htmlEditor.session.setValue(starterHTML);
    cssEditor.session.setValue(starterCSS);
    jsEditor.session.setValue(starterJS);

    // Initial preview build
    rebuildPreview();

    // Handle tabs switching
    $$('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        $$('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        $('#htmlEditor').classList.toggle('hidden', name !== 'html');
        $('#cssEditor').classList.toggle('hidden', name !== 'css');
        $('#jsEditor').classList.toggle('hidden', name !== 'js');
      });
    });

    // Live update preview (debounced)
    let previewTimer;
    [htmlEditor, cssEditor, jsEditor].forEach(ed => {
      ed.session.on('change', () => {
        clearTimeout(previewTimer);
        previewTimer = setTimeout(rebuildPreview, 300);
      });
    });

    // Device toggles
    $$('.device').forEach(btn => btn.addEventListener('click', () => {
      $$('.device').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const w = btn.dataset.w;
      iframeShell.style.width = typeof w === 'string' && w.endsWith('%') ? w : w + 'px';
    }));

    // Buttons
    $('#btnBuild').addEventListener('click', rebuildPreview);
    $('#btnReload').addEventListener('click', rebuildPreview);
    $('#btnFormat').addEventListener('click', formatEditors);
    $('#btnNew').addEventListener('click', newProject);
    $('#btnInsertBase').addEventListener('click', insertBaseTemplate);
    $('#btnDownload').addEventListener('click', exportZip);
    $('#btnImport').addEventListener('click', importFiles);
    $('#btnDark').addEventListener('click', () => {
      Project.theme.darkPreview = !Project.theme.darkPreview;
      info(`Preview theme set to ${Project.theme.darkPreview ? 'dark' : 'light'}.`);
      rebuildPreview();
    });
    $('#btnHelp').addEventListener('click', () => {
      info('Try: "Build a landing page with a navbar, hero, and pricing"; "Add a contact form"; "Change the primary color to #1e40af"; "Regenerate the hero with image on right".');
    });

    // Accent color change
    accentPicker.addEventListener('input', (e) => {
      Project.theme.accent = e.target.value;
      info(`Accent color updated to ${Project.theme.accent}`);
      rebuildPreview();
    });

    // Chat composer
    $('#btnSend').addEventListener('click', onUserSubmit);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onUserSubmit(); }
    });

    $$('.chip').forEach(chip => chip.addEventListener('click', () => {
      input.value = chip.dataset.quick || '';
      onUserSubmit();
    }));

    // -------------------------------
    // Preview builder
    // -------------------------------
    function rebuildPreview() {
      const head = `
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>${baseCSS()}\n${cssEditor.getValue()}</style>
      `;
      const body = `
        ${htmlEditor.getValue()}
        <script>${jsEditor.getValue()}<\/script>
      `;
      const doc = `<!doctype html><html><head>${head}</head><body>${body}</body></html>`;
      iframe.srcdoc = doc;
    }

    // -------------------------------
    // Interaction area utilities
    // -------------------------------
    function addMessage(role, text) {
      const m = document.createElement('div');
      m.className = `msg ${role}`;
      m.innerHTML = `
        <div class="avatar">${role === 'ai' ? 'A' : 'U'}</div>
        <div class="bubble">${text}</div>
      `;
      messages.appendChild(m);
      messages.scrollTop = messages.scrollHeight;
    }
    function ok(text)    { addMessage('ai', `<span class="green">✅</span> ${text}`); }
    function warn(text)  { addMessage('ai', `<span class="yellow">⚠️</span> ${text}`); }
    function info(text)  { addMessage('ai', text); }
    // -------------------------------
    // NL ➜ Code: lightweight rule-based generator
    // -------------------------------
    function onUserSubmit() {
      const text = input.value.trim();
      if (!text) return;
      addMessage('user', escapeHtml(text));
      input.value = '';
      handleInstruction(text);
    }

    function handleInstruction(text) {
      const lower = text.toLowerCase();

      // Global operations
      if (/new project|reset/i.test(text)) { newProject(); ok('Started a fresh project.'); return; }
      if (/export|download/i.test(text)) { exportZip(); ok('Downloaded your project as a ZIP.'); return; }
      const colorHex = text.match(/#([0-9a-f]{3,8})\b/i);
      const colorName = text.match(/\b(blue|indigo|violet|purple|emerald|teal|cyan|rose|amber)\b/i);
      if (/color|accent|primary/i.test(text) && (colorHex || colorName)) {
        const c = colorHex ? `#${colorHex[1]}` : namedToHex(colorName[1]);
        Project.theme.accent = c;
        ok(`Primary accent set to ${c}.`);
        return rebuildPreview();
      }

      // Extract possible labels/text content
      const logo = extractQuoted(text, /(logo|brand|title|site)\s*/i) || (text.match(/logo\s+([A-Za-z0-9\- ]{2,20})/i)?.[1]);
      const linksList = parseCommaList(text, /(links?|menu|items)\s*(?:are|:)\s*/i);
      const title  = extractQuoted(text, /title/i);
      const subtitle = extractQuoted(text, /(subtitle|tagline|subheading)/i);
      const cta = extractQuoted(text, /(cta|button|primary button)/i);
      const cta2 = extractQuoted(text, /(secondary button|secondary cta)/i);

      // Identify components to add
      let didSomething = false;
      if (/navbar|nav bar|navigation/i.test(text)) {
        insertNavbar({ brand: logo || 'BlueForge', links: linksList.length ? linksList : ['Home','Features','Pricing','Contact'], sticky: /sticky/i.test(text) });
        didSomething = true;
      }
      if (/hero|header section|banner/i.test(text)) {
        insertHero({ title: title || 'Elevate your web dev', subtitle: subtitle || 'Build faster with an AI coding assistant.', primary: cta || 'Get started', secondary: cta2 || 'Learn more', variant: /image|split/i.test(text) ? 'split' : 'center' });
        didSomething = true;
      }
      if (/pricing|plans?/i.test(text)) {
        const plans = parseCommaList(text, /(plans?|pricing)\s*(?:are|:)\s*/i);
        insertPricing({ plans: plans.length ? plans : ['Starter', 'Pro', 'Enterprise'] });
        didSomething = true;
      }
      if (/contact form|contact/i.test(text) && !/contact\s*(links?)/i.test(text)) {
        const fields = parseCommaList(text, /(fields?)\s*(?:are|:)\s*/i);
        insertContactForm({ fields: fields.length ? fields : ['name','email','message'] });
        didSomething = true;
      }
      if (/footer/i.test(text)) {
        const links = parseCommaList(text, /(links?|items?)\s*(?:are|:)\s*/i);
        insertFooter({ links: links.length ? links : ['About','Privacy','Terms'] });
        didSomething = true;
      }
      if (/modal/i.test(text)) { insertModal({ title: title || 'Quick modal', body: subtitle || 'This is a simple modal dialog.' }); didSomething = true; }
      if (/tabs?/i.test(text)) { insertTabs({ tabs: ['Overview','Details','FAQ'] }); didSomething = true; }
      if (/accordion|faq/i.test(text)) { insertAccordion(); didSomething = true; }
      if (/cards?|grid/i.test(text) && /features|team|gallery/i.test(text)) { insertCardGrid({ heading: 'Features', items: 3 }); didSomething = true; }

      // Regeneration or edits
      if (/regenerate|refresh/i.test(text) && /hero/i.test(text)) { regenerateComponent('hero', comp => { comp.options.variant = /image|split/i.test(text) ? 'split' : 'center'; }); didSomething = true; }
      if (/edit|change|update/i.test(text) && /cta/i.test(text)) { regenerateComponent('hero', comp => { comp.options.primary = cta || comp.options.primary; comp.options.secondary = cta2 || comp.options.secondary; }); didSomething = true; }
      if (/sticky/i.test(text) && /nav/i.test(text)) { regenerateComponent('navbar', comp => comp.options.sticky = true); didSomething = true; }

      if (!didSomething) {
        warn('I didn’t fully understand. Try specifying components: navbar, hero, pricing, contact form, footer, modal, tabs, accordion, cards.');
      } else {
        rebuildPreview();
      }
      renderComponentList();
    }

    // -------------------------------
    // Component insertion helpers
    // -------------------------------
    function appendToHTML(markup) {
      const current = htmlEditor.getValue();
      htmlEditor.session.setValue(current + '\n\n' + markup);
    }
    function appendToCSS(css) {
      if (!css) return;
      const current = cssEditor.getValue();
      if (!current.includes(css.trim())) {
        cssEditor.session.setValue(current + '\n\n' + css);
      }
    }
    function appendToJS(js) {
      if (!js) return;
      const current = jsEditor.getValue();
      if (!current.includes(js.trim())) {
        jsEditor.session.setValue(current + '\n\n' + js);
      }
    }

    // Insert Navbar
    function insertNavbar(opts = {}) {
      const id = makeId('navbar');
      const { brand='BlueForge', links=['Home','Features','Pricing','Contact'], sticky=false } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"navbar"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Responsive Navbar (generated) -->
<header class="site-header${sticky ? ' is-sticky' : ''}">
  <div class="container">
    <nav class="nav">
      <a href="#" class="brand">${escapeHtml(brand)}</a>
      <button class="nav-toggle" aria-label="Toggle menu">☰</button>
      <ul class="links">
        ${links.map(l => `<li><a href="#">${escapeHtml(l)}</a></li>`).join('\n        ')}
      </ul>
      <a class="btn" href="#">Get started</a>
    </nav>
  </div>
</header>
${markerEnd}`.trim();

      const css = `
/* Navbar base (generated) */
.site-header${sticky ? '.is-sticky' : ''} { ${sticky ? 'position: sticky; top:0; z-index: 50;' : ''} }
.nav { display: grid; grid-template-columns: auto 1fr auto auto; gap: 1rem; align-items: center; padding: .7rem 0 }
.brand { font-weight: 800; color: var(--text); font-size: 1.1rem }
.links { display: flex; gap: 1rem; list-style: none; padding: 0; margin: 0 }
.links a { color: var(--text); opacity: .8 }
.links a:hover { opacity: 1 }
.nav-toggle { display: none; }
@media (max-width: 800px) {
  .nav { grid-template-columns: auto auto 1fr; grid-template-areas: "brand toggle cta" "links links links" }
  .brand { grid-area: brand }
  .nav-toggle { grid-area: toggle; display: inline-flex; border: 1px solid rgba(0,0,0,.1); background: transparent; padding: .4rem .6rem; border-radius: 8px; color: var(--text) }
  .links { grid-area: links; display: none; flex-direction: column; gap: .6rem; margin: .6rem 0 }
  .links.open { display: flex }
}
`.trim();

      const js = `
// Navbar toggle (generated)
document.querySelectorAll('.nav-toggle').forEach(btn=>{
  btn.addEventListener('click',()=>btn.closest('.nav')?.querySelector('.links')?.classList.toggle('open'));
});
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      appendToJS(js);
      Project.components.push({ id, type: 'navbar', options: { brand, links, sticky } });
      ok('Navbar added.');
    }

    // Insert Hero
    function insertHero(opts = {}) {
      const id = makeId('hero');
      const { title='Elevate your web dev', subtitle='Build faster with an AI assistant.', primary='Get started', secondary='Learn more', variant='center' } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"hero"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const heroCenter = `
${markerStart}
<!-- Hero (centered, generated) -->
<section class="hero">
  <div class="container">
    <h1>${escapeHtml(title)}</h1>
    <p class="sub">${escapeHtml(subtitle)}</p>
    <div class="cta">
      <a class="btn" href="#">${escapeHtml(primary)}</a>
      <a class="btn secondary" href="#">${escapeHtml(secondary)}</a>
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const heroSplit = `
${markerStart}
<!-- Hero (split image-right, generated) -->
<section class="hero split">
  <div class="container">
    <div class="col">
      <h1>${escapeHtml(title)}</h1>
      <p class="sub">${escapeHtml(subtitle)}</p>
      <div class="cta">
        <a class="btn" href="#">${escapeHtml(primary)}</a>
        <a class="btn secondary" href="#">${escapeHtml(secondary)}</a>
      </div>
    </div>
    <div class="col">
      <div class="img card">
        <!-- Replace with your image -->
        <img alt="Preview" src="https://images.unsplash.com/photo-1526378722484-bd91ca387e72?q=80&w=1600&auto=format&fit=crop" />
      </div>
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Hero (generated) */
.hero { padding: clamp(2.4rem, 6vw, 4rem) 0 }
.hero h1 { font-size: clamp(1.8rem, 4.6vw, 3rem); line-height: 1.1; margin: 0 0 .6rem }
.hero .sub { color: var(--muted); max-width: 54ch }
.hero .cta { display: flex; gap: .8rem; margin-top: 1rem }
.hero.split .container { display: grid; grid-template-columns: 1.2fr 1fr; gap: 2rem; align-items: center }
.hero .img { overflow: hidden }
.hero .img img { width: 100%; height: auto; border-radius: 12px }
@media (max-width: 900px) {
  .hero.split .container { grid-template-columns: 1fr; }
}
`.trim();

      appendToHTML(variant === 'split' ? heroSplit : heroCenter);
      appendToCSS(css);
      Project.components.push({ id, type: 'hero', options: { title, subtitle, primary, secondary, variant } });
      ok(`Hero (${variant}) added.`);
    }

    // Insert Pricing
    function insertPricing(opts = {}) {
      const id = makeId('pricing');
      const { plans = ['Starter','Pro','Enterprise'] } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"pricing"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Pricing (generated) -->
<section id="pricing" class="section pricing">
  <div class="container">
    <h2 style="margin:0 0 .6rem">Pricing</h2>
    <p class="sub" style="color:var(--muted); margin:0 0 1.2rem">Simple pricing for teams of every size.</p>
    <div class="grid">
      ${plans.map((p, i) => `
      <div class="card">
        <h3>${escapeHtml(p)}</h3>
        <p style="color:var(--muted); margin:.2rem 0 1rem">Great for ${i===0?'starters':i===1?'growing teams':'larger orgs'}.</p>
        <div style="font-weight:800; font-size:1.8rem; margin:.2rem 0 1rem">${i===0?'$9':i===1?'$29':'$79'}<span style="font-size:.9rem; opacity:.7">/mo</span></div>
        <ul style="padding-left: 1.1rem; line-height:1.9; margin:0 0 1rem">
          <li>Feature A</li><li>Feature B</li><li>Feature C</li>
        </ul>
        <a class="btn" href="#">Choose ${escapeHtml(p)}</a>
      </div>`).join('')}
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Pricing (generated) */
.pricing .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 1rem }
.pricing .card { padding: 1.2rem }
.pricing .card h3 { margin: 0 0 .2rem }
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      Project.components.push({ id, type: 'pricing', options: { plans } });
      ok('Pricing section added.');
    }

    // Contact Form
    function insertContactForm(opts = {}) {
      const id = makeId('contact');
      const { fields = ['name','email','message'] } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"contact"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Contact Form (generated) -->
<section id="contact" class="section">
  <div class="container">
    <h2>Contact us</h2>
    <form class="card contact-form" onsubmit="return contactSubmit(event)">
      ${fields.map(f => fieldMarkup(f)).join('\n      ')}
      <button class="btn" type="submit">Send message</button>
    </form>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Contact (generated) */
.contact-form { display: grid; gap: .8rem; max-width: 560px }
.contact-form label { font-weight:600 }
.contact-form input, .contact-form textarea {
  width: 100%; padding: .7rem .8rem; border-radius: 10px; border: 1px solid rgba(0,0,0,.12); background: white; color: #0f172a;
}
.contact-form textarea { min-height: 140px; resize: vertical }
`.trim();

      const js = `
function contactSubmit(e) {
  e.preventDefault();
  alert('Form submitted! (Hook this up to your backend.)');
  return false;
}
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      appendToJS(js);
      Project.components.push({ id, type: 'contact', options: { fields } });
      ok('Contact form added.');
    }

    // Footer
    function insertFooter(opts = {}) {
      const id = makeId('footer');
      const { links = ['About','Privacy','Terms'] } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"footer"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Footer (generated) -->
<footer class="site-footer">
  <div class="container" style="display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap">
    <p style="margin:0">© <span id="year"></span> BlueForge</p>
    <nav style="display:flex; gap:1rem">
      ${links.map(l => `<a href="#">${escapeHtml(l)}</a>`).join('\n      ')}
    </nav>
  </div>
</footer>
${markerEnd}`.trim();

      appendToHTML(html);
      Project.components.push({ id, type: 'footer', options: { links } });
      ok('Footer added.');
    }

    // Modal
    function insertModal(opts = {}) {
      const id = makeId('modal');
      const { title='Quick modal', body='This is a simple modal dialog.' } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"modal"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Modal (generated) -->
<div class="modal-wrap" id="${id}" hidden>
  <div class="modal-backdrop" data-close="${id}"></div>
  <div class="modal card">
    <h3 style="margin-top:0">${escapeHtml(title)}</h3>
    <p>${escapeHtml(body)}</p>
    <div style="display:flex; gap:.6rem; justify-content:flex-end">
      <button class="btn secondary" data-close="${id}">Close</button>
      <button class="btn">Confirm</button>
    </div>
  </div>
</div>
${markerEnd}`.trim();

      const css = `
/* Modal (generated) */
.modal-wrap { position: fixed; inset: 0; display: grid; place-items: center }
.modal-backdrop { position: absolute; inset: 0; background: rgba(2,6,23,.55) }
.modal { position: relative; width: min(520px, 92%); padding: 1rem }
`.trim();

      const js = `
// Modal controls (generated)
document.querySelectorAll('[data-open]').forEach(btn => btn.addEventListener('click', () => {
  const id = btn.getAttribute('data-open');
  document.getElementById(id)?.removeAttribute('hidden');
}));
document.addEventListener('click', (e)=>{
  const target = e.target.closest('[data-close]');
  if (target) document.getElementById(target.getAttribute('data-close'))?.setAttribute('hidden','');
});
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      appendToJS(js);
      Project.components.push({ id, type: 'modal', options: { title, body } });
      ok('Modal added. Use data-open="' + id + '" on any button to open it.');
    }

    // Tabs
    function insertTabs(opts = {}) {
      const id = makeId('tabs');
      const { tabs = ['Overview','Details','FAQ'] } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"tabs"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Tabs (generated) -->
<section class="section">
  <div class="container">
    <div class="tabs-wrap card">
      <div class="tabbar">
        ${tabs.map((t,i)=>`<button class="tab-btn${i===0?' active':''}" data-tab-target="${id}-${i}">${escapeHtml(t)}</button>`).join('')}
      </div>
      <div class="tabpanes">
        ${tabs.map((t,i)=>`<div class="tabpane${i===0?' active':''}" id="${id}-${i}">
          <p>Content for ${escapeHtml(t)}.</p>
        </div>`).join('')}
      </div>
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Tabs (generated) */
.tabs-wrap { padding: .6rem }
.tabbar { display: flex; gap: .4rem; flex-wrap: wrap }
.tab-btn { padding: .5rem .8rem; border-radius: 9px; border: 1px solid rgba(0,0,0,.1); background: transparent; cursor: pointer }
.tab-btn.active { background: var(--accent); color: white; border-color: var(--accent) }
.tabpanes { margin-top: .8rem }
.tabpane { display: none }
.tabpane.active { display: block }
`.trim();

      const js = `
// Tabs (generated)
document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', ()=>{
  const group = btn.closest('.tabs-wrap');
  group.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const id = btn.getAttribute('data-tab-target');
  group.querySelectorAll('.tabpane').forEach(p => p.classList.remove('active'));
  group.querySelector('#'+CSS.escape(id))?.classList.add('active');
}));
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      appendToJS(js);
      Project.components.push({ id, type: 'tabs', options: { tabs } });
      ok('Tabs added.');
    }

    // Accordion
    function insertAccordion() {
      const id = makeId('accordion');
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"accordion"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Accordion (generated) -->
<section class="section">
  <div class="container">
    <div class="accordion card">
      ${[1,2,3].map(i => `
      <details ${i===1?'open':''}>
        <summary><strong>Question ${i}</strong></summary>
        <p>Answer for question ${i}. Replace with your content.</p>
      </details>`).join('')}
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Accordion (generated) */
.accordion details { border-bottom: 1px solid rgba(0,0,0,.08); padding: .4rem 0 }
.accordion summary { cursor: pointer; list-style: none }
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      Project.components.push({ id, type: 'accordion', options: {} });
      ok('Accordion (FAQ) added.');
    }

    // Card Grid (Features)
    function insertCardGrid(opts = {}) {
      const id = makeId('cards');
      const { heading='Features', items=3 } = opts;
      const markerStart = `<!-- AI-COMPONENT {"id":"${id}","type":"cards"} -->`;
      const markerEnd = `<!-- /AI-COMPONENT ${id} -->`;
      const html = `
${markerStart}
<!-- Card Grid (generated) -->
<section class="section">
  <div class="container">
    <h2>${escapeHtml(heading)}</h2>
    <div class="grid">
      ${Array.from({length: items}).map((_,i)=>`
      <div class="card reveal">
        <h3>Card ${i+1}</h3>
        <p>Short description of this item. Replace with your content.</p>
      </div>`).join('')}
    </div>
  </div>
</section>
${markerEnd}`.trim();

      const css = `
/* Card grid (generated) */
.section .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 1rem }
`.trim();

      appendToHTML(html);
      appendToCSS(css);
      Project.components.push({ id, type: 'cards', options: { heading, items } });
      ok('Card grid added.');
    }
    // -------------------------------
    // Regeneration
    // -------------------------------
    function regenerateComponent(type, mutate) {
      const comp = [...Project.components].reverse().find(c => c.type === type);
      if (!comp) { warn(`No ${type} found to regenerate.`); return; }
      mutate(comp);
      // naive replace via markers
      const startMarker = `<!-- AI-COMPONENT {"id":"${comp.id}","type":"${comp.type}"} -->`;
      const endMarker = `<!-- /AI-COMPONENT ${comp.id} -->`;
      let newHTML = '';
      switch (comp.type) {
        case 'hero': {
          const { title, subtitle, primary, secondary, variant } = comp.options;
          newHTML = variant === 'split'
            ? `
${startMarker}
<!-- Hero (split image-right, regenerated) -->
<section class="hero split">
  <div class="container">
    <div class="col">
      <h1>${escapeHtml(title)}</h1>
      <p class="sub">${escapeHtml(subtitle)}</p>
      <div class="cta">
        <a class="btn" href="#">${escapeHtml(primary)}</a>
        <a class="btn secondary" href="#">${escapeHtml(secondary)}</a>
      </div>
    </div>
    <div class="col">
      <div class="img card">
        <img alt="Preview" src="https://images.unsplash.com/photo-1526378722484-bd91ca387e72?q=80&w=1600&auto=format&fit=crop" />
      </div>
    </div>
  </div>
</section>
${endMarker}`.trim()
            : `
${startMarker}
<!-- Hero (centered, regenerated) -->
<section class="hero">
  <div class="container">
    <h1>${escapeHtml(title)}</h1>
    <p class="sub">${escapeHtml(subtitle)}</p>
    <div class="cta">
      <a class="btn" href="#">${escapeHtml(primary)}</a>
      <a class="btn secondary" href="#">${escapeHtml(secondary)}</a>
    </div>
  </div>
</section>
${endMarker}`.trim();
          break;
        }
        case 'navbar': {
          const { brand, links, sticky } = comp.options;
          newHTML = `
${startMarker}
<!-- Navbar (regenerated) -->
<header class="site-header${sticky ? ' is-sticky' : ''}">
  <div class="container">
    <nav class="nav">
      <a href="#" class="brand">${escapeHtml(brand)}</a>
      <button class="nav-toggle" aria-label="Toggle menu">☰</button>
      <ul class="links">
        ${links.map(l => `<li><a href="#">${escapeHtml(l)}</a></li>`).join('\n        ')}
      </ul>
      <a class="btn" href="#">Get started</a>
    </nav>
  </div>
</header>
${endMarker}`.trim();
          break;
        }
        default: warn('Regeneration supported for hero and navbar right now.'); return;
      }
      const current = htmlEditor.getValue();
      const replaced = replaceBetween(current, startMarker, endMarker, newHTML);
      if (replaced) {
        htmlEditor.session.setValue(replaced);
        ok(`${type} updated.`);
      } else {
        warn('Could not locate component markers. It might have been heavily edited.');
      }
    }

    function renderComponentList() {
      compList.innerHTML = '';
      if (!Project.components.length) {
        compList.innerHTML = '<div class="bubble">No components yet. Generate one using the chips or the input above.</div>';
        return;
      }
      Project.components.forEach(c => {
        const el = document.createElement('div');
        el.className = 'comp-item';
        el.innerHTML = `
          <div class="row">
            <div>
              <strong>${c.type}</strong>
              <span class="tag">#${c.id}</span>
            </div>
            <div style="display:flex; gap:6px">
              <button class="btn small" data-act="regen" data-id="${c.id}">Regenerate</button>
              <button class="btn small" data-act="remove" data-id="${c.id}">Remove</button>
            </div>
          </div>
          ${c.type === 'hero' ? `<small class="muted">Variant: <code>${c.options.variant}</code></small>` : ''}
        `;
        compList.appendChild(el);
      });

      compList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const comp = Project.components.find(c => c.id === id);
        if (!comp) return;
        if (btn.dataset.act === 'remove') {
          removeComponent(comp);
        } else if (btn.dataset.act === 'regen') {
          if (comp.type === 'hero') {
            comp.options.variant = comp.options.variant === 'center' ? 'split' : 'center';
            regenerateComponent('hero', () => {});
          } else if (comp.type === 'navbar') {
            comp.options.sticky = !comp.options.sticky;
            regenerateComponent('navbar', () => {});
          } else {
            warn('Quick regenerate available for hero/navbar. Use chat commands to edit others.');
          }
        }
      }, { once: true });
    }

    function removeComponent(comp) {
      const startMarker = `<!-- AI-COMPONENT {"id":"${comp.id}","type":"${comp.type}"} -->`;
      const endMarker = `<!-- /AI-COMPONENT ${comp.id} -->`;
      const current = htmlEditor.getValue();
      const removed = removeBetween(current, startMarker, endMarker);
      if (removed) {
        htmlEditor.session.setValue(removed);
        Project.components = Project.components.filter(c => c.id !== comp.id);
        ok(`Removed ${comp.type} (#${comp.id}).`);
        renderComponentList();
        rebuildPreview();
      } else {
        warn('Could not remove component (markers not found).');
      }
    }

    // -------------------------------
    // Utilities
    // -------------------------------
    function newProject() {
      Project.components = [];
      Project.nextId = 1;
      htmlEditor.session.setValue('<main>\n\n</main>');
      cssEditor.session.setValue('');
      jsEditor.session.setValue('');
      renderComponentList();
      rebuildPreview();
    }
    function insertBaseTemplate() {
      htmlEditor.session.setValue(starterHTML);
      cssEditor.session.setValue(starterCSS);
      jsEditor.session.setValue(starterJS);
      rebuildPreview();
      ok('Base template inserted.');
    }
    function formatEditors() {
      // Lightweight formatter (just trims + simple indentation for CSS/JS)
      htmlEditor.session.setValue(prettyHTML(htmlEditor.getValue()));
      cssEditor.session.setValue(cssEditor.getValue().trim());
      jsEditor.session.setValue(jsEditor.getValue().trim());
      ok('Formatted your code.');
    }
    function exportZip() {
      const zip = new JSZip();
      const indexHTML = `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlueForge Export</title>
<style>
${baseCSS()}
/* --- Your CSS --- */
${cssEditor.getValue()}
</style>
</head>
<body>
${htmlEditor.getValue()}
<script>
${jsEditor.getValue()}
<\/script>
</body>
</html>`;
      zip.file('index.html', indexHTML);
      zip.generateAsync({ type: 'blob' }).then(content => saveAs(content, 'blueforge-project.zip'));
    }
    function importFiles() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = ".html,.htm,.txt";
      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;
        const text = await file.text();
        // Primitive import: try to split into CSS/JS from <style>/<script>, else place in HTML
        const css = (text.match(/<style[^>]*>([\s\S]*?)<\/style>/i)?.[1] || '').trim();
        const js = (text.match(/<script[^>]*>([\s\S]*?)<\/script>/i)?.[1] || '').trim();
        const body = (text.match(/<body[^>]*>([\s\S]*?)<\/body>/i)?.[1] || text).trim();
        htmlEditor.session.setValue(body);
        if (css) cssEditor.session.setValue(css);
        if (js) jsEditor.session.setValue(js);
        ok('Imported file into editors.');
        rebuildPreview();
      };
      input.click();
    }

    function parseCommaList(text, regex) {
      const m = text.match(regex);
      if (!m) return [];
      const after = text.slice(m.index + m[0].length);
      const list = after.split(/[,.]/).map(s => s.trim()).filter(Boolean);
      return list;
    }
    function extractQuoted(text, keyRegex) {
      const re = new RegExp(`${keyRegex.source}["“']([^"”']{1,120})["”']`, 'i');
      return text.match(re)?.[1] || null;
    }
    function makeId(prefix) { return `${prefix}_${Project.nextId++}`; }
    function replaceBetween(str, startMarker, endMarker, replacementBlock) {
      const s = str.indexOf(startMarker);
      const e = str.indexOf(endMarker);
      if (s === -1 || e === -1 || e < s) return null;
      return str.slice(0, s) + replacementBlock + str.slice(e + endMarker.length);
    }
    function removeBetween(str, startMarker, endMarker) {
      const s = str.indexOf(startMarker);
      const e = str.indexOf(endMarker);
      if (s === -1 || e === -1 || e < s) return null;
      return str.slice(0, s) + str.slice(e + endMarker.length);
    }
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }
    function shade(hex, pct) {
      // Shade a hex color by percentage (-100..100)
      const c = hex.replace('#','');
      const bigint = parseInt(c.length === 3 ? c.split('').map(x=>x+x).join('') : c, 16);
      const r = (bigint >> 16) & 255, g = (bigint >> 8) & 255, b = bigint & 255;
      const f = (v) => Math.round(Math.min(255, Math.max(0, v + (pct/100)*255)));
      return '#' + [f(r),f(g),f(b)].map(v=>v.toString(16).padStart(2,'0')).join('');
    }
    function namedToHex(name) {
      const map = { blue:'#2563eb', indigo:'#4f46e5', violet:'#7c3aed', purple:'#9333ea', emerald:'#10b981', teal:'#14b8a6', cyan:'#06b6d4', rose:'#e11d48', amber:'#f59e0b' };
      return map[name.toLowerCase()] || '#2563eb';
    }
    function fieldMarkup(name) {
      const n = name.toLowerCase().trim();
      if (n.includes('message') || n.includes('comments')) {
        return `<label>Message<input as="textarea"/><textarea name="message" placeholder="Your message"></textarea></label>`;
      }
      const type = n.includes('email') ? 'email' : n.includes('phone') ? 'tel' : 'text';
      const label = n[0].toUpperCase() + n.slice(1);
      return `<label>${escapeHtml(label)}<input type="${type}" name="${escapeHtml(n)}" placeholder="Enter ${escapeHtml(n)}" /></label>`;
    }
    function prettyHTML(html) {
      // Very light formatter: ensures newline between sections and trims spaces
      return html.replace(/\n{3,}/g, '\n\n').trim();
    }
  </script>
</body>
</html>


